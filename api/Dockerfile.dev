FROM node:20

WORKDIR /app

COPY package.json package-lock.json ./

COPY api/package.json ./api/

RUN npm ci

COPY api/prisma ./api/prisma

RUN npx prisma generate --schema=./api/prisma/schema.prisma

COPY api/src ./api/src
COPY api/tsconfig.json ./api/tsconfig.json
COPY api/host.ts ./api/host.ts

RUN npm run build:api

ENV DATABASE_URL="postgresql://DEV:PASS@db:5432/MAIN"

EXPOSE 1092

CMD ["npm", "run", "host:api"]
FROM node:20

WORKDIR /app

# Prefer pnpm workspace install to pull prisma-db package
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY api/package.json ./api/
COPY web-frontend/package.json ./web-frontend/
COPY packages/prisma-db/package.json ./packages/prisma-db/

# Install pnpm and workspace deps
RUN npm install -g pnpm && pnpm install --frozen-lockfile

# Copy prisma package sources and generate client
COPY packages/prisma-db ./packages/prisma-db
RUN pnpm --filter @ai-store/prisma-db generate

# Copy api sources
COPY api/src ./api/src
COPY api/tsconfig.json ./api/tsconfig.json
COPY api/host.ts ./api/host.ts

RUN pnpm --filter api build

ENV DATABASE_URL="postgresql://DEV:PASS@db:5432/MAIN"

EXPOSE 1092

CMD ["npm", "run", "host:api"]